# Техническое задание: Редактор топливных карт газобаллонного оборудования Zenit

## Общая информация

**Название проекта:** Zenit Map Editor  
**Версия:** 1.0.0  
**Технологический стек:** Electron, React, Vite, Eslint, Prettier  
**Целевая платформа:** Desktop (Windows, macOS, Linux)  
**Язык интерфейса:** Русский

## Описание проекта

Приложение для редактирования топливных карт газобаллонного оборудования Zenit JZ 2009. Позволяет загружать, просматривать и объединять топливные карты в формате \*.map, с возможностью выбора бензиновых и газовых карт для создания итогового файла.

## Функциональные требования

### 1. Главный экран

#### 1.1 Загрузка файлов

- **Выбор файлов:** Кнопка "Выбрать файлы" для открытия диалога выбора файлов
- **Drag & Drop:** Поддержка перетаскивания файлов \*.map в область приложения (всё окно приложения)
- **Поддержка множественного выбора:** Возможность загрузки нескольких файлов одновременно
- **Валидация файлов:** Проверка корректности формата \*.map
  - Проверка количества строк (должно быть 480 строк)
  - Проверка числового формата данных
  - Проверка диапазона значений (давление: 0-2000 мбар, время впрыска: 0-50 мс)

#### 1.2 Отображение топливных карт

- **Визуализация карт:** Графическое отображение топливных точек на координатной сетке
  - **Ось X:** Давление в коллекторе (мбар) - горизонтальная ось
  - **Ось Y:** Время впрыска (мс) - вертикальная ось
  - **Бензиновые точки:** **синий цвет** (#0066CC)
  - **Газовые точки:** **желтый цвет** (#FFD700)
  - **Масштабирование:** Автоматическое масштабирование для отображения всех 120 точек
  - **Сетка координат:** Отображение осей с подписями и делениями
- **Активный файл:** Полная непрозрачность (opacity: 1.0)
- **Неактивные файлы:** Прозрачность 50% (opacity: 0.5)
- **Переключение активного файла:** Клик по карте для активации
- **Включение/отключение файлов:** Чекбокс для каждого загруженного файла
  - **Включенный файл:** Отображается на экране с соответствующей прозрачностью
  - **Отключенный файл:** Скрыт с экрана (display: none)
  - **Массовое управление:** Кнопки "Включить все" / "Отключить все"
  - **Сохранение состояния:** Запоминание выбора включенных файлов при переключении активной
- **Включение/отключение отдельных карт:** Чекбоксы для бензиновых и газовых карт
  - **Бензиновые карты:** Чекбокс для управления видимостью синих точек
  - **Газовые карты:** Чекбокс для управления видимостью желтых точек
  - **Независимое управление:** Каждая карта может быть включена/отключена отдельно
  - **Сохранение состояния:** Запоминание видимости каждой карты при переключении файлов

#### 1.3 Выбор карт для объединения

- **Структура файлов:** Каждый файл \*.map содержит двойную карту (бензин + газ)
- **Интегрированный выбор:** Радио-кнопки встроены в список загруженных файлов
- **Выбор бензиновой карты:** Радио-кнопка "○ Выбрать" для бензиновой части файла
- **Выбор газовой карты:** Радио-кнопка "○ Выбрать" для газовой части файла
- **Ограничения:** Можно выбрать только одну бензиновую И одну газовую карту (из разных или одного файла)
- **Визуальная индикация:** Выделение выбранных карт в списке файлов
- **Вертикальная прокрутка:** Список файлов с прокруткой при большом количестве

### 2. Сохранение результата

#### 2.1 Кнопка сохранения

- **Кнопка "Сохранить":** Создание итогового файла
- **Имя файла по умчанию:** "${бензиновая карта}M.map"
- **Диалог сохранения:** Возможность изменить имя и путь сохранения
- **Формат файла:** \*.map

## Технические требования

### 1. Архитектура приложения

#### 1.1 Electron структура

```
src/
├── main.js              # Главный процесс Electron
├── renderer/            # Процесс рендеринга
│   ├── index.html       # Главная страница
│   ├── styles.css       # Стили приложения
│   └── script.js        # Логика интерфейса
├── utils/               # Утилиты
│   ├── fileHandler.js   # Обработка файлов *.map
│   └── mapRenderer.js   # Рендеринг карт
└── assets/              # Ресурсы
    └── icons/           # Иконки приложения
```

#### 1.2 Основные модули

- **File Handler:** Парсинг и валидация файлов \*.map
- **Map Renderer:** Визуализация топливных карт на Canvas/SVG
- **State Manager:** Управление состоянием приложения
- **Export Manager:** Создание итогового файла

### 2. Формат файлов \*.map

#### 2.1 Структура данных

Файлы \*.map содержат топливные карты в текстовом формате с разделителями `\r\n`. Каждая карта состоит из 120 точек данных (480 строк), где каждая точка представлена двумя значениями:

```javascript
// Структура файла *.map
// Каждая строка содержит одно числовое значение
// Формат: X_бенз1, Y_бенз1, X_газ1, Y_газ1, X_бенз2, Y_бенз2, X_газ2, Y_газ2, ... (120 точек = 480 значений)

// Пример данных из 31102018.map:
// 320    <- X_бенз1 (Давление в коллекторе, мбар)
// 4,4    <- Y_бенз1 (Время впрыска, мс)
// 560    <- X_газ1 (Давление в коллекторе, мбар)
// 12     <- Y_газ1 (Время впрыска, мс)
// 320    <- X_бенз2 (Давление в коллекторе, мбар)
// 4,4    <- Y_бенз2 (Время впрыска, мс)
// 860    <- X_газ2 (Давление в коллекторе, мбар)
// 15,6   <- Y_газ2 (Время впрыска, мс)
// ...    <- 120 точек данных (480 строк)

// Структура для обработки в приложении:
{
  fileName: string,           // Название файла (например, "31102018.map")
  petrolMap: {               // Бензиновая карта (строки 0,1,4,5,8,9...)
    points: [                // Массив из 120 топливных точек
      {
        x: number,           // Давление в коллекторе (мбар)
        y: number,           // Время впрыска (мс)
        index: number        // Индекс точки (0-119)
      }
    ]
  },
  gasMap: {                  // Газовая карта (строки 2,3,6,7,10,11...)
    points: [                // Массив из 120 топливных точек
      {
        x: number,           // Давление в коллекторе (мбар)
        y: number,           // Время впрыска (мс)
        index: number        // Индекс точки (0-119)
      }
    ]
  },
  rawData: string[],         // Исходные данные файла (480 строк)
  totalPoints: 240           // Общее количество точек (120 бензин + 120 газ)
}
```

#### 2.2 Объединение карт

При объединении бензиновой и газовой карт используется алгоритм из `mergeMaps.js`:

```javascript
// Алгоритм объединения для двойных карт:
// - Берется бензиновая карта из выбранного файла (строки 0,1,4,5,8,9...)
// - Берется газовая карта из выбранного файла (строки 2,3,6,7,10,11...)
// - Создается новая карта: [X1_бенз, Y1_бенз, X1_газ, Y1_газ, X2_бенз, Y2_бенз, X2_газ, Y2_газ, ...]
// - Итоговый файл содержит 480 строк (120 точек × 4 значения)

const mergedMap = [];
for (let i = 0; i < 120; i++) {
  const offset = i * 4;
  mergedMap.push(petrolMap[offset]); // X бензин (строка 0,4,8,12...)
  mergedMap.push(petrolMap[offset + 1]); // Y бензин (строка 1,5,9,13...)
  mergedMap.push(gasMap[offset + 2]); // X газ (строка 2,6,10,14...)
  mergedMap.push(gasMap[offset + 3]); // Y газ (строка 3,7,11,15...)
}
```

### 3. Пользовательский интерфейс

#### 3.1 Макет главного экрана

**Двухколоночный макет:**

- **Левая колонка (flex):** Область отображения графика с Canvas
- **Правая колонка (200px):** Панель управления с загруженными картами

**Особенности макета:**

- **Адаптивность:** Возможность изменения пропорций колонок
- **Вертикальная прокрутка:** Список карт с прокруткой при большом количестве файлов
- **Интегрированный интерфейс:** Все элементы управления в правой панели
- **Полноэкранный график:** Максимальное использование пространства для визуализации

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Zenit Map Editor                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────┐ ┌─────────────────────────────────────────┐ │
│ │                             │ │ [Выбрать файлы]                         │ │
│ │                             │ ├─────────────────────────────────────────┤ │
│ │        ГРАФИК               │ │ Загруженные файлы:                      │ │
│ │     (Canvas область)        │ │ [Включить все] [Отключить все]          │ │
│ │                             │ │                                         │ │
│ │  ┌─────────────────────┐    │ │ ┌─────────────────────────────────────┐ │ │
│ │  │                     │    │ │ │ ☑ 31102018.map                      │ │ │
│ │  │   Топливные точки   │    │ │ │   ┌─ ☑ Бензин: ○                    │ │ │
│ │  │   • • • • • • •     │    │ │ │   └─ ☑ Газ: ○                       │ │ │
│ │  │   • • • • • • •     │    │ │ │                                     │ │ │
│ │  │   • • • • • • •     │    │ │ │ ☑ 15112018.map                      │ │ │
│ │  │   • • • • • • •     │    │ │ │   ┌─ ☑ Бензин: ○                    │ │ │
│ │  │                     │    │ │ │   └─ ☑ Газ: ○                       │ │ │
│ │  └─────────────────────┘    │ │ │                                     │ │ │
│ │                             │ │ │ ☐ 20122018.map                      │ │ │
│ │  X: Давление (мбар)         │ │ │   ┌─ ☑ Бензин: ○                    │ │ │
│ │  Y: Время впрыска (мс)      │ │ │   └─ ☑ Газ: ○                       │ │ │
│ │                             │ │ │                                     │ │ │
│ │                             │ │ │ ☐ 05012019.map                      │ │ │
│ │                             │ │ │   ┌─ ☑ Бензин: ○                    │ │ │
│ │                             │ │ │   └─ ☑ Газ: ○                       │ │ │
│ │                             │ │ │                                     │ │ │
│ │                             │ │ │ ...                                 │ │ │
│ │                             │ │ └─────────────────────────────────────┘ │ │
│ │                             │ │                                         │ │
│ │                             │ │ [Сохранить] Имя: [бензиновая карта.map] │ │
│ │                             │ │                                         │ │
│ └─────────────────────────────┘ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2 Стили и цвета

- **Основной цвет:** #2C3E50 (темно-синий)
- **Акцентный цвет:** #3498DB (голубой)
- **Бензиновые точки:** #0066CC (синий)
- **Газовые точки:** #FFD700 (желтый)
- **Фон:** #ECF0F1 (светло-серый)
- **Текст:** #2C3E50 (темно-синий)

### 4. Функциональные модули

#### 4.1 File Handler (fileHandler.js)

```javascript
class FileHandler {
  // Загрузка и парсинг файлов *.map
  loadMapFile(filePath)

  // Парсинг данных из формата \r\n в двойную карту
  parseMapData(rawData)

  // Валидация формата файла (проверка на 480 строк)
  validateMapFile(data)

  // Извлечение бензиновой карты (строки 0,1,4,5,8,9...)
  extractPetrolMap(rawData)

  // Извлечение газовой карты (строки 2,3,6,7,10,11...)
  extractGasMap(rawData)

  // Создание объединенной карты из выбранных бензиновой и газовой карт
  mergeMaps(selectedPetrolMap, selectedGasMap)

  // Сохранение объединенной карты в файл
  saveMergedMap(mergedData, fileName)
}
```

#### 4.2 Map Renderer (mapRenderer.js)

```javascript
class MapRenderer {
  // Инициализация Canvas с координатной системой
  initCanvas(canvasElement)

  // Настройка координатной сетки
  setupCoordinateSystem()

  // Рендеринг координатных осей
  renderAxes()

  // Рендеринг топливных точек карты с поддержкой видимости отдельных карт
  renderMap(mapData, isActive, mapVisibility)

  // Масштабирование для отображения всех точек
  calculateScale(points)

  // Преобразование координат в пиксели
  pointToPixel(x, y)

  // Обработка кликов по карте
  handleMapClick(event)

  // Обновление прозрачности
  updateOpacity(mapId, opacity)

  // Управление видимостью файлов
  showMap(mapId)
  hideMap(mapId)
  toggleMapVisibility(mapId)

  // Массовое управление видимостью файлов
  showAllMaps()
  hideAllMaps()

  // Основной метод рендеринга с поддержкой видимости отдельных карт
  render(visibleMaps)
}
```

#### 4.3 State Manager

```javascript
class StateManager {
  // Управление загруженными файлами с двойными картами
  loadedFiles: Map[]

  // Активный файл
  activeFile: string | null

  // Выбранные карты для объединения (из разных файлов)
  selectedPetrolMap: {fileName: string, mapType: 'petrol'} | null
  selectedGasMap: {fileName: string, mapType: 'gas'} | null

  // Видимость файлов
  visibleFiles: Set<string>

  // Видимость отдельных карт {fileId: {petrol: boolean, gas: boolean}}
  visibleMaps: Map<string, Object>

  // Методы управления состоянием
  addFile(fileData)
  setActiveFile(fileName)
  selectMapForMerge(fileName, mapType)

  // Методы управления видимостью файлов
  toggleFileVisibility(fileName)
  setAllFilesVisible(visible)
  isFileVisible(fileName)

  // Методы управления видимостью отдельных карт
  toggleMapVisibility(fileId, mapType)
  setMapVisibility(fileId, mapType, visible)
  isMapVisible(fileId, mapType)
  setAllMapsVisible(mapType, visible)
}
```

## Нефункциональные требования

### 1. Производительность

- **Время загрузки:** < 3 секунд для файлов до 10MB
- **Отзывчивость UI:** < 100ms для переключения между картами
- **Память:** < 500MB для работы с 50+ картами

### 2. Совместимость

- **Windows:** 10, 11
- **macOS:** 10.15+
- **Linux:** Ubuntu 18.04+, CentOS 7+

### 3. Безопасность

- **Валидация файлов:** Проверка формата и размера
- **Изоляция:** Sandbox режим Electron
- **Обработка ошибок:** Graceful handling всех исключений

## Структура проекта

### Файловая структура

```
zenit-map-editor/
├── package.json                    # Конфигурация проекта и зависимости
├── package-lock.json              # Заблокированные версии зависимостей
├── .gitignore                     # Исключения для Git
├── README.md                      # Документация проекта
├── DEVELOPMENT.md                 # Руководство разработчика
├── LICENSE                        # Лицензия MIT
├── src/                          # Исходный код приложения
│   ├── main.js                   # Главный процесс Electron
│   ├── preload.js                # Preload скрипт для безопасности
│   └── renderer/                 # Процесс рендеринга
│       ├── index.html            # Главная страница приложения
│       ├── styles.css            # Стили приложения
│       ├── script.js             # Основная логика интерфейса
│       └── utils/                # Утилиты приложения
│           ├── fileHandler.js    # Обработка файлов *.map
│           ├── mapRenderer.js    # Рендеринг карт на Canvas
│           └── stateManager.js   # Управление состоянием
├── assets/                       # Ресурсы приложения
│   └── icons/                    # Иконки приложения
│       └── icon.svg              # SVG иконка приложения
└── tech_spec/                    # Техническая документация
    ├── TECHNICAL_SPECIFICATION.md # Техническое задание
    └── 11072017-gasoline.map     # Пример файла карты
```

### Основные компоненты

#### 1. Главный процесс (main.js)

- Инициализация Electron приложения
- Создание главного окна
- Обработка IPC сообщений для файловых операций
- Диалоги выбора и сохранения файлов

#### 2. Preload скрипт (preload.js)

- Безопасное взаимодействие между процессами
- Предоставление API для renderer процесса
- Изоляция контекста

#### 3. Renderer процесс

- **index.html**: HTML структура интерфейса
- **styles.css**: CSS стили и темы
- **script.js**: Основная логика приложения
- **utils/**: Модули функциональности

#### 4. Утилиты

- **fileHandler.js**: Парсинг и валидация .map файлов
- **mapRenderer.js**: Визуализация карт на Canvas
- **stateManager.js**: Управление состоянием приложения

## План разработки

### Этап 1: Базовая структура (1-2 недели)

- [ ] Настройка Electron проекта
- [ ] Создание двухколоночного макета (график слева, управление справа)
- [ ] Реализация загрузки файлов
- [ ] Drag & Drop функциональность
- [ ] Вертикальный список загруженных файлов с прокруткой
- [ ] Отображение двойных карт (бензин + газ) в каждом файле

### Этап 2: Визуализация карт (2-3 недели)

- [ ] Парсинг формата \*.map (480 строк → двойная карта)
- [ ] Извлечение бензиновой карты (строки 0,1,4,5,8,9...)
- [ ] Извлечение газовой карты (строки 2,3,6,7,10,11...)
- [ ] Валидация файлов (проверка структуры и диапазонов)
- [ ] Canvas рендеринг с координатной системой
- [ ] Отображение осей X (давление) и Y (время впрыска)
- [ ] Автоматическое масштабирование точек
- [ ] Система активации файлов
- [ ] Управление прозрачностью
- [ ] Система включения/отключения файлов (чекбоксы)
- [ ] Система включения/отключения отдельных карт (чекбоксы для бензин/газ)
- [ ] Независимое управление видимостью бензиновых и газовых карт
- [ ] Массовое управление видимостью файлов

### Этап 3: Выбор и объединение (1-2 недели)

- [ ] Интегрированные радио-кнопки в списке файлов
- [ ] Система выбора бензиновой и газовой карт из файлов
- [ ] Валидация выбора (1 бензин + 1 газ из любых файлов)
- [ ] Визуальная индикация выбранных карт в списке файлов
- [ ] Реализация алгоритма объединения для двойных карт
- [ ] Создание объединенной карты (480 строк: X*бенз, Y*бенз, X*газ, Y*газ)
- [ ] Экспорт итогового файла с именем по умолчанию

### Этап 4: Тестирование и полировка (1 неделя)

- [ ] Unit тесты
- [ ] Интеграционные тесты
- [ ] UI/UX улучшения
- [ ] Документация

## Текущий статус проекта

### ✅ Выполнено (Этапы 1-3)

**Базовая структура:**

- ✅ Electron приложение настроено и работает
- ✅ Двухколоночный макет реализован
- ✅ Система загрузки файлов с drag & drop
- ✅ Вертикальный список файлов с прокруткой

**Визуализация карт:**

- ✅ Парсинг .map файлов с межстрочной структурой данных
- ✅ Извлечение бензиновых и газовых карт
- ✅ Canvas рендеринг с координатной системой
- ✅ Автоматическое масштабирование
- ✅ Система активации файлов
- ✅ Управление прозрачностью
- ✅ Система включения/отключения файлов
- ✅ Система включения/отключения отдельных карт (бензин/газ)
- ✅ Независимое управление видимостью карт

**Выбор и объединение:**

- ✅ Интегрированные радио-кнопки в списке файлов
- ✅ Система выбора карт для объединения
- ✅ Валидация выбора
- ✅ Алгоритм объединения карт
- ✅ Экспорт объединенных файлов

### 🔄 В процессе

**Тестирование:**

- 🔄 Тестирование с реальными файлами
- 🔄 Проверка производительности
- 🔄 Валидация пользовательского интерфейса

### 📋 Планируется

**Дополнительные возможности:**

- 📋 Предварительный просмотр объединенной карты
- 📋 Настройки цветов и прозрачности
- 📋 Экспорт в различные форматы
- 📋 Редактирование топливных точек
- 📋 Сравнение карт

## Критерии приемки

### 1. Функциональные критерии

- ✅ Загрузка множественных файлов \*.map
- ✅ Drag & Drop поддержка
- ✅ Визуализация бензиновых (синий) и газовых (желтый) точек на координатной сетке
- ✅ Отображение осей: X (давление в коллекторе, мбар) и Y (время впрыска, мс)
- ✅ Автоматическое масштабирование для отображения всех 120 точек
- ✅ Переключение активной карты
- ✅ Включение/отключение отображения файлов (чекбоксы)
- ✅ Включение/отключение отдельных карт (чекбоксы для бензин/газ)
- ✅ Независимое управление видимостью бензиновых и газовых карт
- ✅ Массовое управление видимостью ("Включить все" / "Отключить все")
- ✅ Двухколоночный макет (график слева, управление справа)
- ✅ Вертикальное расположение списка загруженных файлов
- ✅ Отображение двойных карт (бензин + газ) в каждом файле
- ✅ Интегрированный выбор карт для объединения в списке файлов
- ✅ Выбор одной бензиновой и одной газовой карты (из разных или одного файла)
- ✅ Сохранение с именем по умолчанию "${выбранная бензиновая карта}M.map"

### 2. Технические критерии

- ✅ Стабильная работа на всех целевых платформах
- ✅ Обработка ошибок и некорректных файлов
- ✅ Производительность согласно требованиям
- ✅ Чистый и поддерживаемый код

## Дополнительные возможности (будущие версии)

### v1.1

- Предварительный просмотр объединенной карты
- Настройки цветов и прозрачности
- Экспорт в различные форматы

### v1.2

- Редактирование топливных точек
- Создание новых карт
- История изменений

### v1.3

- Сравнение карт
- Статистика по топливным точкам
- Пакетная обработка файлов

---

**Дата создания:** $(date)  
**Версия документа:** 1.0  
**Автор:** Yury Marmysh
